variables:
  DEBIAN_FRONTEND: noninteractive
  DOCKER_HOST: "tcp://docker:2376"
  DOCKER_CERT_PATH: "/certs/client"
  DOCKER_TLS_VERIFY: "1"
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - test

include:
  - project: 'Northern.tech/Mender/mendertesting'
    file:
      - '.gitlab-ci-check-commits.yml'
      - '.gitlab-ci-check-license.yml'
      - '.gitlab-ci-github-status-updates.yml'
      - '.gitlab-ci-check-shell-format.yml'

test:check-shell-formatting:
  before_script:
    - SHELL_SCRIPTS="src/app src/app-modules/docker-compose gen/app-gen tests/app/run.sh tests/app/scenarios/00_basic_ArtifactInstall.run.sh acceptance-tests/scenarios.d/00.basic.non.delta.successful.sh acceptance-tests/run.sh acceptance-tests/bt/main.sh acceptance-tests/bt/lib/functions.sh acceptance-tests/bt/bt.sh"

test:smoketests:
  stage: test
  variables:
    DOCKER_BUILDKIT: 0
    COMPOSE_DOCKER_CLI_BUILD: 0
  tags:
    - docker
  image: tiangolo/docker-with-compose
  services:
    - name: docker:20.10.10-dind-alpine3.14
      alias: docker
  before_script:
    - apk --update --no-cache add bash gawk curl aws-cli tree xz jq wget xdelta3 openssl1.1-compat gcompat
  script:
    - ./tests/app/run.sh
    - ./tests/gen/run.sh
  artifacts:
    expire_in: 2w
    paths:
      - tests/app/data/docker/output
      - tests/gen/data/docker/output
    when: always

test:acceptancetests:
  stage: test
  image: ubuntu:20.04
  services:
    - docker:dind
  before_script:
    - apt update && apt install -yy bash wget xz-utils awscli docker.io curl make xdelta3 tree containerd
    - docker ps
    - docker info
    - mkdir -p ~/.docker/cli-plugins/
    - curl -SL https://github.com/docker/compose/releases/download/v2.3.3/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
    - chmod +x ~/.docker/cli-plugins/docker-compose
    - ~/.docker/cli-plugins/docker-compose --help
    - cp ~/.docker/cli-plugins/docker-compose /usr/bin/
    - docker compose version
    - echo "installing k3d"
    - wget -q -O - https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
#    - k3d cluster create acceptance-tests
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - mv ./kubectl /usr/bin/kubectl
    - sleep 32
    - ps axuw
    - ctr --help
    - kubectl get pods -A
#    - /usr/bin/containerd &
    - ln -sf /bin/true /bin/ctr
    - ln -sf /bin/true /usr/bin/ctr

  script:
    - ./acceptance-tests/run.sh

test:acceptancetests:k8s:
  tags:
    - mender-qa-worker-integration-tests
  stage: test
  image: docker:dind
  variables:
    DOCKER_CLIENT_TIMEOUT: 300
    COMPOSE_HTTP_TIMEOUT: 300
    TEST_SUITE: "open"
  before_script:
    - chmod o+rw /dev/kvm
    - sysctl -w fs.inotify.max_user_instances=1024
    - sysctl -w vm.max_map_count=262144
    - apk --update add curl jq sysstat hdparm wget bash vim xz
    - unset DOCKER_HOST
    - unset DOCKER_TLS_VERIFY
    - unset DOCKER_CERT_PATH
    - export TINI_SUBREAPER=true # https://github.com/krallin/tini#subreaping
    - |-
      # The entrypoint script additionally uses docker-init as workarround of known
      # containerd issue - https://github.com/docker-library/docker/issues/318
      run_dockerd() {
        /bin/sh -c '/usr/local/bin/dockerd-entrypoint.sh &>${CI_PROJECT_DIR}/dockerd.log &'
      }
      # Run dockerd and wait it to start
      MAX_WAIT=60
      while [ ${MAX_WAIT} -gt 0 ]; do
        echo "[$(date +%F_%T)] MAX_WAIT=${MAX_WAIT}"; ps # Debug information
        if docker version &>/dev/null; then
          docker version # Verify that the dockerd is up and running
          break
        elif ! ps -o comm | grep -q -E "docker-init|dockerd|containerd|dockerd-entry|dind|openssl"; then
          run_dockerd # Run dockerd if no related processes are running
        fi
        MAX_WAIT=$((${MAX_WAIT} - 1))
        sleep 1
      done
    - curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
    - chmod +x ./kind
    - mv ./kind /usr/bin/kind
  script:
    - wget -q -O - https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
    - k3d cluster create acceptance-tests
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - mv ./kubectl /usr/bin/kubectl
    - kubectl get nodes
    - kubectl create deployment postgres --image=postgres:15.4 --port=5432 --replicas=1
    - sleep 120
    - kubectl get pods 
    - kubectl get pods -A
#     - kind create cluster --name acc
#     - kind get clusters
#     - kind delete cluster --name acc
#     - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
#     - chmod +x ./kubectl
#     - mv ./kubectl /usr/bin/kubectl
#     - kubectl get pods -A

  after_script:
    # Make sure docker clients (cli and python) interacts with dockerd via socket
    - unset DOCKER_HOST
    - unset DOCKER_TLS_VERIFY
    - unset DOCKER_CERT_PATH

