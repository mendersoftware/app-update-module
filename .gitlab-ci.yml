variables:
  DEBIAN_FRONTEND: noninteractive
  DOCKER_HOST: "tcp://docker:2376"
  DOCKER_CERT_PATH: "/certs/client"
  DOCKER_TLS_VERIFY: "1"
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - test

include:
  - project: 'Northern.tech/Mender/mendertesting'
    file:
      - '.gitlab-ci-check-commits.yml'
      - '.gitlab-ci-check-license.yml'
      - '.gitlab-ci-github-status-updates.yml'
      - '.gitlab-ci-check-shell-format.yml'

test:check-shell-formatting:
  before_script:
    - SHELL_SCRIPTS="src/app src/app-modules/docker-compose gen/app-gen tests/app/run.sh tests/app/scenarios/00_basic_ArtifactInstall.run.sh acceptance-tests/scenarios.d/00.basic.non.delta.successful.sh acceptance-tests/run.sh acceptance-tests/bt/main.sh acceptance-tests/bt/lib/functions.sh acceptance-tests/bt/bt.sh"

test:smoketests:
  stage: test
  variables:
    DOCKER_BUILDKIT: 0
    COMPOSE_DOCKER_CLI_BUILD: 0
  tags:
    - docker
  image: tiangolo/docker-with-compose
  services:
    - name: docker:20.10.10-dind-alpine3.14
      alias: docker
  before_script:
    - apk --update --no-cache add bash gawk curl aws-cli tree xz jq wget xdelta3 openssl1.1-compat gcompat
  script:
    - ./tests/app/run.sh
    - ./tests/gen/run.sh
  artifacts:
    expire_in: 2w
    paths:
      - tests/app/data/docker/output
      - tests/gen/data/docker/output
    when: always

test:acceptancetests:k8s:
  image: debian:buster
  services:
    - docker:dind
  stage: test
  tags:
    - mender-qa-slave
  before_script:
    # Default value, will later be overwritten if successful
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get update -y
    - apt-get -yy -q --no-install-recommends install iptables ebtables ethtool
      ca-certificates conntrack socat git nfs-common glusterfs-client
      cifs-utils apt-transport-https ca-certificates curl gnupg2
      software-properties-common bridge-utils ipcalc aufs-tools
      sudo procps vim curl bash make uuid-runtime jq
    - apt-get clean
    # Install docker
    - curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
    - apt-key fingerprint 0EBFCD88
    - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian buster stable"
    - apt-get update
    - apt-get install -y docker-ce docker-ce-cli containerd.io
    - apt-get clean
    # Install kubectl
    - curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
    - add-apt-repository "deb https://apt.kubernetes.io/ kubernetes-xenial main"
    - apt-get update
    - apt-get install --reinstall -y kubeadm kubelet kubectl
    # Install kind
    - curl -Lo ./kind https://github.com/kubernetes-sigs/kind/releases/download/v0.6.1/kind-Linux-amd64
    - chmod 755 kind
    - mv kind /usr/bin/
    - export KUBECONFIG=/etc/kubernetes/admin.conf
    - acceptance-tests/k8s/ci-prepare.sh
    - acceptance-tests/k8s/ci-start-k8s.sh
  script:
    - kubectl get pods -A
 
test:acceptancetests:
  image: ubuntu:20.04
  services:
    - docker:dind
  before_script:
    - apt update && apt install -yy bash wget xz-utils awscli docker.io curl make xdelta3 tree
    - docker ps
    - docker info
    - mkdir -p ~/.docker/cli-plugins/
    - curl -SL https://github.com/docker/compose/releases/download/v2.3.3/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
    - chmod +x ~/.docker/cli-plugins/docker-compose
    - ~/.docker/cli-plugins/docker-compose --help
    - cp ~/.docker/cli-plugins/docker-compose /usr/bin/
    - docker compose version

  script:
    - ./acceptance-tests/run.sh
